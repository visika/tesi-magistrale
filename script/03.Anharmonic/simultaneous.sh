#!/usr/bin/env sh
# TODO Adatta lo script al sistema ibisco
# Procedura dalla lezione del 2023-05-12
cp /data/studenti/Esercitazioni22/POTCAR .
# Vogliamo una super-cella con 64 atomi, cioè 4x4x4
# Scegliamo un volume di 16.6 * 64 = 1062.4
v=16.6
vsuper=1062.4
t=600
cat > POSCAR <<EOF
super cell
        -$vsuper
   2.000000000000000   0.000000000000000   2.000000000000000
   2.000000000000000   2.000000000000000   0.000000000000000
   0.000000000000000   2.000000000000000   2.000000000000000
   64
 Direct
   0.000000000000000   0.000000000000000   0.000000000000000
   0.250000000000000   0.000000000000000   0.000000000000000
   0.500000000000000   0.000000000000000   0.000000000000000
   0.750000000000000   0.000000000000000   0.000000000000000
   0.000000000000000   0.250000000000000   0.000000000000000
   0.250000000000000   0.250000000000000   0.000000000000000
   0.500000000000000   0.250000000000000   0.000000000000000
   0.750000000000000   0.250000000000000   0.000000000000000
   0.000000000000000   0.500000000000000   0.000000000000000
   0.250000000000000   0.500000000000000   0.000000000000000
   0.500000000000000   0.500000000000000   0.000000000000000
   0.750000000000000   0.500000000000000   0.000000000000000
   0.000000000000000   0.750000000000000   0.000000000000000
   0.250000000000000   0.750000000000000   0.000000000000000
   0.500000000000000   0.750000000000000   0.000000000000000
   0.750000000000000   0.750000000000000   0.000000000000000
   0.000000000000000   0.000000000000000   0.250000000000000
   0.250000000000000   0.000000000000000   0.250000000000000
   0.500000000000000   0.000000000000000   0.250000000000000
   0.750000000000000   0.000000000000000   0.250000000000000
   0.000000000000000   0.250000000000000   0.250000000000000
   0.250000000000000   0.250000000000000   0.250000000000000
   0.500000000000000   0.250000000000000   0.250000000000000
   0.750000000000000   0.250000000000000   0.250000000000000
   0.000000000000000   0.500000000000000   0.250000000000000
   0.250000000000000   0.500000000000000   0.250000000000000
   0.500000000000000   0.500000000000000   0.250000000000000
   0.750000000000000   0.500000000000000   0.250000000000000
   0.000000000000000   0.750000000000000   0.250000000000000
   0.250000000000000   0.750000000000000   0.250000000000000
   0.500000000000000   0.750000000000000   0.250000000000000
   0.750000000000000   0.750000000000000   0.250000000000000
   0.000000000000000   0.000000000000000   0.500000000000000
   0.250000000000000   0.000000000000000   0.500000000000000
   0.500000000000000   0.000000000000000   0.500000000000000
   0.750000000000000   0.000000000000000   0.500000000000000
   0.000000000000000   0.250000000000000   0.500000000000000
   0.250000000000000   0.250000000000000   0.500000000000000
   0.500000000000000   0.250000000000000   0.500000000000000
   0.750000000000000   0.250000000000000   0.500000000000000
   0.000000000000000   0.500000000000000   0.500000000000000
   0.250000000000000   0.500000000000000   0.500000000000000
   0.500000000000000   0.500000000000000   0.500000000000000
   0.750000000000000   0.500000000000000   0.500000000000000
   0.000000000000000   0.750000000000000   0.500000000000000
   0.250000000000000   0.750000000000000   0.500000000000000
   0.500000000000000   0.750000000000000   0.500000000000000
   0.750000000000000   0.750000000000000   0.500000000000000
   0.000000000000000   0.000000000000000   0.750000000000000
   0.250000000000000   0.000000000000000   0.750000000000000
   0.500000000000000   0.000000000000000   0.750000000000000
   0.750000000000000   0.000000000000000   0.750000000000000
   0.000000000000000   0.250000000000000   0.750000000000000
   0.250000000000000   0.250000000000000   0.750000000000000
   0.500000000000000   0.250000000000000   0.750000000000000
   0.750000000000000   0.250000000000000   0.750000000000000
   0.000000000000000   0.500000000000000   0.750000000000000
   0.250000000000000   0.500000000000000   0.750000000000000
   0.500000000000000   0.500000000000000   0.750000000000000
   0.750000000000000   0.500000000000000   0.750000000000000
   0.000000000000000   0.750000000000000   0.750000000000000
   0.250000000000000   0.750000000000000   0.750000000000000
   0.500000000000000   0.750000000000000   0.750000000000000
   0.750000000000000   0.750000000000000   0.750000000000000
EOF

cat > SPOSCAR <<EOF
super cell
        4.0000000000
   2.000000000000000   0.000000000000000   2.000000000000000
   2.000000000000000   2.000000000000000   0.000000000000000
   0.000000000000000   2.000000000000000   2.000000000000000
   64
 Direct
   0.000000000000000   0.000000000000000   0.000000000000000
   0.250000000000000   0.000000000000000   0.000000000000000
   0.500000000000000   0.000000000000000   0.000000000000000
   0.750000000000000   0.000000000000000   0.000000000000000
   0.000000000000000   0.250000000000000   0.000000000000000
   0.250000000000000   0.250000000000000   0.000000000000000
   0.500000000000000   0.250000000000000   0.000000000000000
   0.750000000000000   0.250000000000000   0.000000000000000
   0.000000000000000   0.500000000000000   0.000000000000000
   0.250000000000000   0.500000000000000   0.000000000000000
   0.500000000000000   0.500000000000000   0.000000000000000
   0.750000000000000   0.500000000000000   0.000000000000000
   0.000000000000000   0.750000000000000   0.000000000000000
   0.250000000000000   0.750000000000000   0.000000000000000
   0.500000000000000   0.750000000000000   0.000000000000000
   0.750000000000000   0.750000000000000   0.000000000000000
   0.000000000000000   0.000000000000000   0.250000000000000
   0.250000000000000   0.000000000000000   0.250000000000000
   0.500000000000000   0.000000000000000   0.250000000000000
   0.750000000000000   0.000000000000000   0.250000000000000
   0.000000000000000   0.250000000000000   0.250000000000000
   0.250000000000000   0.250000000000000   0.250000000000000
   0.500000000000000   0.250000000000000   0.250000000000000
   0.750000000000000   0.250000000000000   0.250000000000000
   0.000000000000000   0.500000000000000   0.250000000000000
   0.250000000000000   0.500000000000000   0.250000000000000
   0.500000000000000   0.500000000000000   0.250000000000000
   0.750000000000000   0.500000000000000   0.250000000000000
   0.000000000000000   0.750000000000000   0.250000000000000
   0.250000000000000   0.750000000000000   0.250000000000000
   0.500000000000000   0.750000000000000   0.250000000000000
   0.750000000000000   0.750000000000000   0.250000000000000
   0.000000000000000   0.000000000000000   0.500000000000000
   0.250000000000000   0.000000000000000   0.500000000000000
   0.500000000000000   0.000000000000000   0.500000000000000
   0.750000000000000   0.000000000000000   0.500000000000000
   0.000000000000000   0.250000000000000   0.500000000000000
   0.250000000000000   0.250000000000000   0.500000000000000
   0.500000000000000   0.250000000000000   0.500000000000000
   0.750000000000000   0.250000000000000   0.500000000000000
   0.000000000000000   0.500000000000000   0.500000000000000
   0.250000000000000   0.500000000000000   0.500000000000000
   0.500000000000000   0.500000000000000   0.500000000000000
   0.750000000000000   0.500000000000000   0.500000000000000
   0.000000000000000   0.750000000000000   0.500000000000000
   0.250000000000000   0.750000000000000   0.500000000000000
   0.500000000000000   0.750000000000000   0.500000000000000
   0.750000000000000   0.750000000000000   0.500000000000000
   0.000000000000000   0.000000000000000   0.750000000000000
   0.250000000000000   0.000000000000000   0.750000000000000
   0.500000000000000   0.000000000000000   0.750000000000000
   0.750000000000000   0.000000000000000   0.750000000000000
   0.000000000000000   0.250000000000000   0.750000000000000
   0.250000000000000   0.250000000000000   0.750000000000000
   0.500000000000000   0.250000000000000   0.750000000000000
   0.750000000000000   0.250000000000000   0.750000000000000
   0.000000000000000   0.500000000000000   0.750000000000000
   0.250000000000000   0.500000000000000   0.750000000000000
   0.500000000000000   0.500000000000000   0.750000000000000
   0.750000000000000   0.500000000000000   0.750000000000000
   0.000000000000000   0.750000000000000   0.750000000000000
   0.250000000000000   0.750000000000000   0.750000000000000
   0.500000000000000   0.750000000000000   0.750000000000000
   0.750000000000000   0.750000000000000   0.750000000000000
EOF

for folder in 00 01 02 03 04 05
do
mkdir $folder
cp POSCAR $folder
done

cat > 01/INCAR <<EOF
XLAMBDA=0.0
EOF

cat > 02/INCAR <<EOF
XLAMBDA=0.333333333
EOF

cat > 03/INCAR <<EOF
XLAMBDA=0.666666666
EOF

cat > 04/INCAR <<EOF
XLAMBDA=1.0
EOF

# Allo stato dei fatti, abbiamo una struttura con tutti gli atomi
# nelle proprie posizioni di equilibrio. Avviando VASP con questa
# configurazione, otterremmo un valore dell'energia corrispondente a
# U_0. Dobbiamo configurare INCAR per abilitare la dinamica
# molecolare. Il parametro per attivare la dinamica molecolare è
# IBRION=0.

# TODO NSW dovrebbe essere 2000 per avere buoni risultati, ma ora sto
# facendo un test, quindi lo imposto a 200.

# POTIM=3.0 è il passo temporale in femto secondi. TEBEG=600 è la
# temperatura iniziale della simulazione.

# Usiamo EDIFF=1d-4 perché la convergenza sia meno stringente e più
# rapida. IALGO=48 impiega un algoritmo di diagonalizzazione più
# rapido ma anche più instabile. MAXMIX=40 utilizza più densità dai
# passi precedenti, per velocizzare la convergenza.

# TIPO=inteharm indica che vogliamo effettuare l'integrazione
# termodinamica con una combinazione di potenziale armonico e
# potenziale completo.
cat > INCAR <<EOF
EDIFF=1d-4
SIGMA=0.544
LWAVE=.FALSE.
LCHARG=.FALSE.
IMAGES=4
SPRING=-1000

#ENCUT=400

NPAR=1

IALGO=48
IBRION=0
NSW=500
#ISYM=0
POTIM=3.0
TEBEG=$t
LANDERSON=.T.
NANDERSON=50
#POMASS=26.98
#NBLOCK=5
#NWRITE=0
MAXMIX=40

TIPO=inteharm
#TIPO=harmonic
XMIXHARM=1.0
XMIXREF=0.0
R1=8.05
NCELL=64

XLAMBDA=0.0
#LADIABATIC=.T.
EOF
# Dato che ci interessano solo le differenze rispetto al valore di
# riferimento dell'energia, effettuiamo i calcoli solo in un punto.
cat > KPOINTS <<EOF
auto 
 0
Gamma
1 1 1
0 0 0
EOF
# Remember to use the correct HARMONIC file force constant matrix and set the correct radius
cp "/data/studenti/mollo/harmonicpotential/HARMONIC.v$v" HARMONIC
# Run VASP
/opt/openmpi/1.6/ifort-12.1.4/bin/mpirun -np 16 /home/nm_settings/software/CODES/VASP/bin/vasp-4.6.alfe-gamma
