#!/usr/bin/bash
# ---------------------------------------------------------------
#   batch file to run over several diplaced atoms
# ---------------------------------------------------------------

echo "Starting runphon"
echo "VASP executable is $vasp_std"

if test -f POSCAR.phon; then 
  echo "POSCAR.phon exist remove before starting batchfile"
  exit 1
fi

cp POSCAR POSCAR.phon 
#
#  loop over all exited ions
#
j=0
for i in \
 "   1  0.00520963  0.00000000  0.00000000 " \
 "   1 -0.00000000  0.00520963  0.00000000 " \
 "   1  0.00000000  0.00000000  0.00552901 " \
 "   2  0.00520963  0.00000000  0.00000000 " \
 "   2 -0.00000000  0.00520963  0.00000000 " \
 "   2  0.00000000  0.00000000  0.00552901 " \
 "   3  0.00520963  0.00000000  0.00000000 " \
 "   3 -0.00000000  0.00520963  0.00000000 " \
 "   3  0.00000000  0.00000000  0.00552901 " \
 "   4  0.00520963  0.00000000  0.00000000 " \
 "   4 -0.00000000  0.00520963  0.00000000 " \
 "   4  0.00000000  0.00000000  0.00552901 " \
 "   5  0.00520963  0.00000000  0.00000000 " \
 "   5 -0.00000000  0.00520963  0.00000000 " \
 "   5  0.00000000  0.00000000  0.00552901 " \
 "   6  0.00520963  0.00000000  0.00000000 " \
 "   6 -0.00000000  0.00520963  0.00000000 " \
 "   6  0.00000000  0.00000000  0.00552901 " \
 "   7  0.00520963  0.00000000  0.00000000 " \
 "   7 -0.00000000  0.00520963  0.00000000 " \
 "   7  0.00000000  0.00000000  0.00552901 " \
 "   8  0.00520963  0.00000000  0.00000000 " \
 "   8 -0.00000000  0.00520963  0.00000000 " \
 "   8  0.00000000  0.00000000  0.00552901 " \
 "   9  0.00520963  0.00000000  0.00000000 " \
 "   9 -0.00000000  0.00520963  0.00000000 " \
 "   9  0.00000000  0.00000000  0.00552901 " \
 "  10  0.00520963  0.00000000  0.00000000 " \
 "  10 -0.00000000  0.00520963  0.00000000 " \
 "  10  0.00000000  0.00000000  0.00552901 " \
 "  11  0.00520963  0.00000000  0.00000000 " \
 "  11 -0.00000000  0.00520963  0.00000000 " \
 "  11  0.00000000  0.00000000  0.00552901 " \
 "  12  0.00520963  0.00000000  0.00000000 " \
 "  12 -0.00000000  0.00520963  0.00000000 " \
 "  12  0.00000000  0.00000000  0.00552901 " \
 "  13  0.00520963  0.00000000  0.00000000 " \
 "  13 -0.00000000  0.00520963  0.00000000 " \
 "  13  0.00000000  0.00000000  0.00552901 " \
 "  14  0.00520963  0.00000000  0.00000000 " \
 "  14 -0.00000000  0.00520963  0.00000000 " \
 "  14  0.00000000  0.00000000  0.00552901 " \
 "  15  0.00520963  0.00000000  0.00000000 " \
 "  15 -0.00000000  0.00520963  0.00000000 " \
 "  15  0.00000000  0.00000000  0.00552901 " \
 "  16  0.00520963  0.00000000  0.00000000 " \
 "  16 -0.00000000  0.00520963  0.00000000 " \
 "  16  0.00000000  0.00000000  0.00552901 " \
 "  17  0.00520963  0.00000000  0.00000000 " \
 "  17 -0.00000000  0.00520963  0.00000000 " \
 "  17  0.00000000  0.00000000  0.00552901 " \
 "  18  0.00520963  0.00000000  0.00000000 " \
 "  18 -0.00000000  0.00520963  0.00000000 " \
 "  18  0.00000000  0.00000000  0.00552901 " \
 "  19  0.00520963  0.00000000  0.00000000 " \
 "  19 -0.00000000  0.00520963  0.00000000 " \
 "  19  0.00000000  0.00000000  0.00552901 " \
 "  20  0.00520963  0.00000000  0.00000000 " \
 "  20 -0.00000000  0.00520963  0.00000000 " \
 "  20  0.00000000  0.00000000  0.00552901 " \
 "  21  0.00520963  0.00000000  0.00000000 " \
 "  21 -0.00000000  0.00520963  0.00000000 " \
 "  21  0.00000000  0.00000000  0.00552901 " \
 "  22  0.00520963  0.00000000  0.00000000 " \
 "  22 -0.00000000  0.00520963  0.00000000 " \
 "  22  0.00000000  0.00000000  0.00552901 " \
 "  23  0.00520963  0.00000000  0.00000000 " \
 "  23 -0.00000000  0.00520963  0.00000000 " \
 "  23  0.00000000  0.00000000  0.00552901 " \
 "  24  0.00520963  0.00000000  0.00000000 " \
 "  24 -0.00000000  0.00520963  0.00000000 " \
 "  24  0.00000000  0.00000000  0.00552901 " \
 "  25  0.00520963  0.00000000  0.00000000 " \
 "  25 -0.00000000  0.00520963  0.00000000 " \
 "  25  0.00000000  0.00000000  0.00552901 " \
 "  26  0.00520963  0.00000000  0.00000000 " \
 "  26 -0.00000000  0.00520963  0.00000000 " \
 "  26  0.00000000  0.00000000  0.00552901 " \
 "  27  0.00520963  0.00000000  0.00000000 " \
 "  27 -0.00000000  0.00520963  0.00000000 " \
 "  27  0.00000000  0.00000000  0.00552901 " \
 "  28  0.00520963  0.00000000  0.00000000 " \
 "  28 -0.00000000  0.00520963  0.00000000 " \
 "  28  0.00000000  0.00000000  0.00552901 " \
 "  29  0.00520963  0.00000000  0.00000000 " \
 "  29 -0.00000000  0.00520963  0.00000000 " \
 "  29  0.00000000  0.00000000  0.00552901 " \
 "  30  0.00520963  0.00000000  0.00000000 " \
 "  30 -0.00000000  0.00520963  0.00000000 " \
 "  30  0.00000000  0.00000000  0.00552901 " \
 "  31  0.00520963  0.00000000  0.00000000 " \
 "  31 -0.00000000  0.00520963  0.00000000 " \
 "  31  0.00000000  0.00000000  0.00552901 " \
 "  32  0.00520963  0.00000000  0.00000000 " \
 "  32 -0.00000000  0.00520963  0.00000000 " \
 "  32  0.00000000  0.00000000  0.00552901 " \
 "  33  0.00520963  0.00000000  0.00000000 " \
 "  33 -0.00000000  0.00520963  0.00000000 " \
 "  33  0.00000000  0.00000000  0.00552901 " \
 "  34  0.00520963  0.00000000  0.00000000 " \
 "  34 -0.00000000  0.00520963  0.00000000 " \
 "  34  0.00000000  0.00000000  0.00552901 " \
 "  35  0.00520963  0.00000000  0.00000000 " \
 "  35 -0.00000000  0.00520963  0.00000000 " \
 "  35  0.00000000  0.00000000  0.00552901 " \
 "  36  0.00520963  0.00000000  0.00000000 " \
 "  36 -0.00000000  0.00520963  0.00000000 " \
 "  36  0.00000000  0.00000000  0.00552901 " \
 "   1 -0.00520963 -0.00000000 -0.00000000 " \
 "   1  0.00000000 -0.00520963 -0.00000000 " \
 "   1 -0.00000000 -0.00000000 -0.00552901 " \
 "   2 -0.00520963 -0.00000000 -0.00000000 " \
 "   2  0.00000000 -0.00520963 -0.00000000 " \
 "   2 -0.00000000 -0.00000000 -0.00552901 " \
 "   3 -0.00520963 -0.00000000 -0.00000000 " \
 "   3  0.00000000 -0.00520963 -0.00000000 " \
 "   3 -0.00000000 -0.00000000 -0.00552901 " \
 "   4 -0.00520963 -0.00000000 -0.00000000 " \
 "   4  0.00000000 -0.00520963 -0.00000000 " \
 "   4 -0.00000000 -0.00000000 -0.00552901 " \
 "   5 -0.00520963 -0.00000000 -0.00000000 " \
 "   5  0.00000000 -0.00520963 -0.00000000 " \
 "   5 -0.00000000 -0.00000000 -0.00552901 " \
 "   6 -0.00520963 -0.00000000 -0.00000000 " \
 "   6  0.00000000 -0.00520963 -0.00000000 " \
 "   6 -0.00000000 -0.00000000 -0.00552901 " \
 "   7 -0.00520963 -0.00000000 -0.00000000 " \
 "   7  0.00000000 -0.00520963 -0.00000000 " \
 "   7 -0.00000000 -0.00000000 -0.00552901 " \
 "   8 -0.00520963 -0.00000000 -0.00000000 " \
 "   8  0.00000000 -0.00520963 -0.00000000 " \
 "   8 -0.00000000 -0.00000000 -0.00552901 " \
 "   9 -0.00520963 -0.00000000 -0.00000000 " \
 "   9  0.00000000 -0.00520963 -0.00000000 " \
 "   9 -0.00000000 -0.00000000 -0.00552901 " \
 "  10 -0.00520963 -0.00000000 -0.00000000 " \
 "  10  0.00000000 -0.00520963 -0.00000000 " \
 "  10 -0.00000000 -0.00000000 -0.00552901 " \
 "  11 -0.00520963 -0.00000000 -0.00000000 " \
 "  11  0.00000000 -0.00520963 -0.00000000 " \
 "  11 -0.00000000 -0.00000000 -0.00552901 " \
 "  12 -0.00520963 -0.00000000 -0.00000000 " \
 "  12  0.00000000 -0.00520963 -0.00000000 " \
 "  12 -0.00000000 -0.00000000 -0.00552901 " \
 "  13 -0.00520963 -0.00000000 -0.00000000 " \
 "  13  0.00000000 -0.00520963 -0.00000000 " \
 "  13 -0.00000000 -0.00000000 -0.00552901 " \
 "  14 -0.00520963 -0.00000000 -0.00000000 " \
 "  14  0.00000000 -0.00520963 -0.00000000 " \
 "  14 -0.00000000 -0.00000000 -0.00552901 " \
 "  15 -0.00520963 -0.00000000 -0.00000000 " \
 "  15  0.00000000 -0.00520963 -0.00000000 " \
 "  15 -0.00000000 -0.00000000 -0.00552901 " \
 "  16 -0.00520963 -0.00000000 -0.00000000 " \
 "  16  0.00000000 -0.00520963 -0.00000000 " \
 "  16 -0.00000000 -0.00000000 -0.00552901 " \
 "  17 -0.00520963 -0.00000000 -0.00000000 " \
 "  17  0.00000000 -0.00520963 -0.00000000 " \
 "  17 -0.00000000 -0.00000000 -0.00552901 " \
 "  18 -0.00520963 -0.00000000 -0.00000000 " \
 "  18  0.00000000 -0.00520963 -0.00000000 " \
 "  18 -0.00000000 -0.00000000 -0.00552901 " \
 "  19 -0.00520963 -0.00000000 -0.00000000 " \
 "  19  0.00000000 -0.00520963 -0.00000000 " \
 "  19 -0.00000000 -0.00000000 -0.00552901 " \
 "  20 -0.00520963 -0.00000000 -0.00000000 " \
 "  20  0.00000000 -0.00520963 -0.00000000 " \
 "  20 -0.00000000 -0.00000000 -0.00552901 " \
 "  21 -0.00520963 -0.00000000 -0.00000000 " \
 "  21  0.00000000 -0.00520963 -0.00000000 " \
 "  21 -0.00000000 -0.00000000 -0.00552901 " \
 "  22 -0.00520963 -0.00000000 -0.00000000 " \
 "  22  0.00000000 -0.00520963 -0.00000000 " \
 "  22 -0.00000000 -0.00000000 -0.00552901 " \
 "  23 -0.00520963 -0.00000000 -0.00000000 " \
 "  23  0.00000000 -0.00520963 -0.00000000 " \
 "  23 -0.00000000 -0.00000000 -0.00552901 " \
 "  24 -0.00520963 -0.00000000 -0.00000000 " \
 "  24  0.00000000 -0.00520963 -0.00000000 " \
 "  24 -0.00000000 -0.00000000 -0.00552901 " \
 "  25 -0.00520963 -0.00000000 -0.00000000 " \
 "  25  0.00000000 -0.00520963 -0.00000000 " \
 "  25 -0.00000000 -0.00000000 -0.00552901 " \
 "  26 -0.00520963 -0.00000000 -0.00000000 " \
 "  26  0.00000000 -0.00520963 -0.00000000 " \
 "  26 -0.00000000 -0.00000000 -0.00552901 " \
 "  27 -0.00520963 -0.00000000 -0.00000000 " \
 "  27  0.00000000 -0.00520963 -0.00000000 " \
 "  27 -0.00000000 -0.00000000 -0.00552901 " \
 "  28 -0.00520963 -0.00000000 -0.00000000 " \
 "  28  0.00000000 -0.00520963 -0.00000000 " \
 "  28 -0.00000000 -0.00000000 -0.00552901 " \
 "  29 -0.00520963 -0.00000000 -0.00000000 " \
 "  29  0.00000000 -0.00520963 -0.00000000 " \
 "  29 -0.00000000 -0.00000000 -0.00552901 " \
 "  30 -0.00520963 -0.00000000 -0.00000000 " \
 "  30  0.00000000 -0.00520963 -0.00000000 " \
 "  30 -0.00000000 -0.00000000 -0.00552901 " \
 "  31 -0.00520963 -0.00000000 -0.00000000 " \
 "  31  0.00000000 -0.00520963 -0.00000000 " \
 "  31 -0.00000000 -0.00000000 -0.00552901 " \
 "  32 -0.00520963 -0.00000000 -0.00000000 " \
 "  32  0.00000000 -0.00520963 -0.00000000 " \
 "  32 -0.00000000 -0.00000000 -0.00552901 " \
 "  33 -0.00520963 -0.00000000 -0.00000000 " \
 "  33  0.00000000 -0.00520963 -0.00000000 " \
 "  33 -0.00000000 -0.00000000 -0.00552901 " \
 "  34 -0.00520963 -0.00000000 -0.00000000 " \
 "  34  0.00000000 -0.00520963 -0.00000000 " \
 "  34 -0.00000000 -0.00000000 -0.00552901 " \
 "  35 -0.00520963 -0.00000000 -0.00000000 " \
 "  35  0.00000000 -0.00520963 -0.00000000 " \
 "  35 -0.00000000 -0.00000000 -0.00552901 " \
 "  36 -0.00520963 -0.00000000 -0.00000000 " \
 "  36  0.00000000 -0.00520963 -0.00000000 " \
 "  36 -0.00000000 -0.00000000 -0.00552901 "
do
j=`expr $j + 1`
echo "run number $j"

#
# use awk to displace atoms (somewhat tricky)
#
awk '
/SUBSIT/  { npos = $2 ; 
            x=$3; y=$4 ; z=$5; }
!/SUBSIT/ { line=line+1 
  if (line-7 == npos) {
    printf "%12.9f %12.9f %12.9f\n", $1+x, $2+y, $3+z
  } 
  else if (line > 7) {
    printf "%12.9f %12.9f %12.9f\n", $1, $2, $3
  } 
  else 
    print 
} ' >POSCAR <<!
SUBSIT $i
`cat POSCAR.phon`
!

# cat POSCAR
if test ! -f OUTCAR.$j 
then
# here the call to VASP
#../../vasp/vasp.4.4.k/vasp
echo "Call VASP"
# mpirun -np 4 "$vasp_std" >out.vasp
mpirun -np 1 "$vasp_std"
# "$vasp_std" >out.vasp
mv OUTCAR OUTCAR.$j
fi
#
# use awk to extract forces 
#
echo $i >DYNMAT.$j
awk '
/total drift:/ { start=0}
!/----------/  { if ( start ==1) { printf "%14.8f  %14.8f  %14.8f\n",$4,$5,$6  }}
/TOTAL-FORCE/  { start = 1}
' <OUTCAR.$j >>DYNMAT.$j

done

# restore POSCAR file
mv POSCAR.phon POSCAR

echo $j > FORCES
i=1
while test $i -le $j
do 
cat DYNMAT.$i >> FORCES
i=`expr $i + 1`
done
